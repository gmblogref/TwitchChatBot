<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Twitch Alert Overlay</title>
    <link rel="stylesheet" href="stylealerts.css?v=2" />
</head>
<body>
    <div id="alert"></div>
    <div id="media"></div>

    <script>
        const alertBox = document.getElementById("alert");
        const mediaBox = document.getElementById("media");
        let playing = false;
        let ws;
        let currentAlertId = null;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${location.hostname}:3000/ws`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                // Ping/pong to keep connection alive (server sends pings every 30s)
                if (data.type === "ping") {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: "pong" }));
                    }
                    return;
                }

                // Only handle normal alerts here
                if (data.type !== "alert") return;

                // If already playing something, ignore (server serializes anyway)
                if (playing) return;

                currentAlertId = data.alertId || null;

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ack", alertId: currentAlertId }));
                }

                playAlert(data.message, data.media);
            };

            ws.onclose = () => setTimeout(connectWebSocket, 3000); // auto-reconnect
        }
        connectWebSocket();

        async function playAlert(message, media) {
            playing = true;

            // Show optional text
            alertBox.textContent = message || "";
            alertBox.style.opacity = 1;
            mediaBox.innerHTML = "";

            if (media?.endsWith(".mp4")) {
                const video = document.createElement("video");
                video.src = media;
                video.autoplay = true;
                video.playsInline = true;
                video.muted = false;
                video.volume = 1.0;
                mediaBox.appendChild(video);

                await video.play().catch(() => null);
                await new Promise(resolve => video.onended = resolve);
                await sleep(1000);

            } else if (media?.endsWith(".gif")) {
                const img = document.createElement("img");
                img.src = media;
                mediaBox.appendChild(img);
                await sleep(5000);
                await sleep(1000);

            } else if (media?.endsWith(".mp3")) {
                const audio = new Audio(media);
                audio.volume = 1.0;
                await audio.play().catch(() => null);
                await new Promise(resolve => audio.onended = resolve);
                await sleep(1000);

            } else {
                await sleep(5000);
                await sleep(1000);
            }

            // Reset visuals
            alertBox.style.opacity = 0;
            mediaBox.innerHTML = "";
            playing = false;

            // ✅ Notify server this alert finished
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "done" }));
            }
            currentAlertId = null;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>